<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 * 라운지 매퍼 XML
 * @author 조희정
 * @since 2024.08.25
 * @version 1.0
 *
 * <pre>
 * 수정일        	수정자        수정내용
 * ==========  =========    =========
 * 2024.08.25  	조희정        최초 생성
 * 2024.08.25  	조희정        selectLoungeList 쿼리 추가
 * 2024.08.26  	조희정        selectLoungeInfo, selectLoungePostList, selectAttendanceList, selectLoungeMemberList, selectLoungePostDetail 쿼리 추가
 * 2024.08.27  	조희정        selectLoungePostImgList, selectLoungeCommentList 쿼리 추가
 * </pre>
 -->
<mapper namespace="com.innerpeace.themoonha.domain.lounge.mapper.LoungeMapper">

    <!-- 작성자 정보 -->
    <resultMap id="LoungeMemberMap" type="com.innerpeace.themoonha.domain.lounge.dto.LoungeMemberDTO">
        <id property="memberId" column="member_id"/>
        <result property="name" column="name"/>
        <result property="profileImgUrl" column="profile_img_url" />
    </resultMap>

    <!--댓글 정보-->
    <resultMap id="LoungeCommentMap" type="com.innerpeace.themoonha.domain.lounge.dto.LoungeCommentDTO">
        <id property="loungeCommentId" column="lounge_comment_id"/>
        <result property="content" column="content"/>
        <result property="createdAt" column="created_at"/>
        <association property="loungeMember" resultMap="LoungeMemberMap"/>
    </resultMap>

    <!-- LoungePostDTO -->
    <resultMap id="LoungePostMap" type="com.innerpeace.themoonha.domain.lounge.dto.LoungePostDTO">
        <id property="loungePostId" column="lounge_post_id"/>
        <result property="content" column="content"/>
        <result property="noticeYn" column="notice_yn"/>
        <result property="createdAt" column="created_at"/>
        <association property="loungeMember" resultMap="LoungeMemberMap"/>
    </resultMap>

    <!-- LoungePostDetailDTO -->
    <resultMap id="LoungePostDetailMap" type="com.innerpeace.themoonha.domain.lounge.dto.LoungePostDetailDTO" extends="LoungePostMap">
        <association property="loungePost" resultMap="LoungePostMap"/>
        <collection property="loungeCommentList" ofType="com.innerpeace.themoonha.domain.lounge.dto.LoungeCommentDTO" resultMap="LoungeCommentMap"/>
    </resultMap>

    <!-- 라운지 목록 조회 -->
    <select id="selectLoungeList"
            resultType="com.innerpeace.themoonha.domain.lounge.dto.LoungeListResponse">
        SELECT /*+ INDEX_DESC(lp PK_LOUNGE_POST) */
            lo.lounge_id,
            le.title,
            lo.lounge_img_url,
            lp.created_at AS latest_post_time
        FROM
            sugang s
                JOIN member m ON m.member_id = s.member_id
                JOIN lounge lo ON lo.lesson_id = s.lesson_id
                JOIN lesson le ON s.lesson_id = le.lesson_id
                LEFT JOIN lounge_post lp ON lo.lounge_id = lp.lounge_id
                AND lp.created_at = (
                    SELECT /*+ INDEX_DESC(lp PK_LOUNGE_POST) */
                        MAX(created_at)
                    FROM lounge_post
                    WHERE lounge_id = lo.lounge_id
                )
        WHERE
            m.member_id = #{memberId}
          AND s.online_yn = 0
          AND s.lounge_yn = 1
    </select>

    <!-- 라운지 기본 정보 조회 -->
    <select id="selectLoungeInfo"
            resultType="com.innerpeace.themoonha.domain.lounge.dto.LoungeInfoDTO">
        SELECT
            le.lesson_id,
            le.title,
            lo.lounge_img_url,
            m.member_id AS tutor_id,
            m.name AS tutor_name,
            le.summary
        FROM
            lesson le
                JOIN member m ON le.member_id = m.member_id
                JOIN lounge lo ON le.lesson_id = lo.lesson_id
        WHERE
            lo.lounge_id = #{loungeId}
    </select>

    <!-- 라운지 게시글 목록 조회 -->
    <select id="selectLoungePostList"
            resultMap="LoungePostMap">
        SELECT /*+ INDEX_ASC(lp PK_LOUNGE_POST) ORDERED */
            lp.lounge_post_id,
            lp.content,
            lp.notice_yn,
            lp.created_at,
            lm.member_id,
            lm.name,
            lm.profile_img_url
        FROM
            lounge_post lp
                LEFT JOIN member lm ON lp.member_id = lm.member_id
        WHERE
            lp.lounge_id = #{loungeId}
        ORDER BY
            lp.lounge_post_id DESC
    </select>


    <!-- 라운지 게시글 당 이미지 조회 -->
    <select id="selectLoungePostImgList"
            resultType="string">
        SELECT /*+ INDEX_ASC(lpi PK_LOUNGE_POST_IMG) ORDERED */
            lpi.post_img_url
        FROM
            lounge_post_img lpi
        WHERE
            lpi.lounge_post_id = #{loungePostId}
        ORDER BY
            lpi.lounge_post_img_id ASC
    </select>

    <!-- 라운지 수강생 출석 조회 -->
    <select id="selectAttendanceList"
            resultType="com.innerpeace.themoonha.domain.lounge.dto.AttendanceDTO">
        SELECT /*+ INDEX_ASC(a PK_ATTENDANCE) INDEX_ASC(sm PK_MEMBER) */
            a.attendance_date,
            a.attendance_yn,
            sm.member_id,
            sm.name
        FROM
            attendance a
                JOIN sugang s ON a.sugang_id = s.sugang_id
                LEFT JOIN member sm ON s.member_id = sm.member_id
        WHERE
            s.lesson_id = (
                SELECT lesson_id
                FROM lounge
                WHERE lounge_id = #{loungeId}
                )
            <if test="role == 'ROLE_MEMBER'">
                AND s.member_id = #{memberId}
            </if>
        ORDER BY
            a.attendance_date ASC,
            sm.name ASC
    </select>

    <!-- 라운지 참여자 조회 -->
    <select id="selectLoungeMemberList"
            resultType="com.innerpeace.themoonha.domain.lounge.dto.LoungeMemberDTO">
        SELECT /*+ INDEX_ASC(m PK_MEMBER) */
            m.member_id,
            m.name,
            m.profile_img_url
        FROM
            sugang su
                JOIN member m ON su.member_id = m.member_id
        WHERE
            su.lesson_id = #{lessonId}
          AND su.online_yn = 0
          AND su.lounge_yn = 1
        ORDER BY
            m.member_id ASC
    </select>

    <!-- 라운지 게시글 상세 한 건 조회 -->
    <select id="selectLoungePostDetail"
            resultMap="LoungePostMap">
        SELECT /*+ INDEX_ASC(lp PK_LOUNGE_POST) ORDERED */
            lp.lounge_post_id,
            lp.content,
            lp.notice_yn,
            lp.created_at,
            lm.member_id,
            lm.name,
            lm.profile_img_url
        FROM
            lounge_post lp
                LEFT JOIN member lm ON lp.member_id = lm.member_id
        WHERE
            lp.lounge_post_id = #{loungePostId}
    </select>

    <!-- 라운지 게시글 댓글 조회 -->
    <select id="selectLoungeCommentList"
            resultMap="LoungeCommentMap">
                SELECT /*+ INDEX_ASC(lp PK_LOUNGE_COMMENT) ORDERED */
                    lc.lounge_comment_id,
                    lc.content,
                    lc.created_at,
                    lcm.member_id,
                    lcm.name,
                    lcm.profile_img_url
                FROM
                    lounge_comment lc
                        LEFT JOIN member lcm ON lc.member_id = lcm.member_id
                WHERE
                    lc.lounge_post_id = #{loungePostId}
                ORDER BY
                    lc.lounge_comment_id ASC
    </select>

    <!-- 라운지 게시물 등록 -->
    <insert id="insertLoungePost" keyProperty="loungePostRequest.loungePostId">
        <selectKey keyProperty="loungePostRequest.loungePostId" resultType="long" order="BEFORE">
            SELECT lounge_post_seq.nextval from dual
        </selectKey>
        INSERT INTO lounge_post (lounge_post_id, member_id, lounge_id, content, notice_yn)
        VALUES (#{loungePostRequest.loungePostId}, #{memberId}, #{loungePostRequest.loungeId}, #{loungePostRequest.content}, #{loungePostRequest.noticeYn})
    </insert>

    <!-- 라운지 게시물 이미지 등록 -->
    <insert id="insertLoungePostImgUrls">
        INSERT INTO lounge_post_img (lounge_post_img_id, lounge_post_id, post_img_url)
        VALUES (lounge_post_img_seq.nextval, #{loungePostId}, #{postImgUrl})
    </insert>

    <!-- 라운지 댓글 등록 -->
    <insert id="insertLoungeComment">
        INSERT INTO lounge_comment(lounge_comment_id, member_id, lounge_post_id, content)
        VALUES (lounge_comment_seq.nextval, #{memberId}, #{loungeComment.loungePostId}, #{loungeComment.content})
    </insert>

</mapper>